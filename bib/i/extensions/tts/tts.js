/*!
 *
 * # BiB/i Extension: OverReflow
 *
 * - "Overlays Reflowable Content Layers on Pre-Paginated Book"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
Bibi.x({name:"Text To Speech",description:"text to speech for BiB/i",version:"0.2.0",build:20170806.0001})(function(){function e(){var e=this,n=e.Rate;f.rate=X.TTS.Rate=n,S["use-cookie"]&&O.Cookie.eat(O.RootPath,{TTS:{Rate:n}})}function t(){var e=I.Menu.TTS.Speech.ButtonGroup.Buttons;speechSynthesis.cancel(f),X.TTS.isSpeeking=!1,I.setUIState(e[0],"default")}function a(){var e,n=R.Current.Pages.EndPage!=R.Pages[R.Pages.length-1]||100!=R.Current.Pages.EndPageRatio,a=(R.Current.Pages.EndPage,R.Current.Pages.StartPage),i=R.getCurrent(),o=i.Page.PageIndex;d=[],d.length=0,e=a.Item.ItemIndex+1,o=e+1,n?(R.focusOn(o),setTimeout(u,1e3)):t()}function i(e,n){var t,o,s,l,r=d.length;if(e>=r)return a(),!0;if(e<0&&(e=0),h=e,c=n,X.TTS.isSpeeking){if(o=d[e][0],t=d[e][1],0===t.length)return void i(e+1,n);s=o.parentElement,l=s.style,1===s.nodeType&&l&&(l.backgroundColor=g),R.focusOn({Destination:{Element:s,Page:n.Page}}),f.text=t,f.onerror=function(e){return!1},f.onstart=function(e){speaking=!0},f.onend=function(t){speaking=!1,l&&(l.backgroundColor=""),setTimeout(function(){i(e+1,n)},10)},speechSynthesis.speak(f)}}function o(e,n){var t,a,i,o=e;for(a=n.length,t=0;t<a;t++)i=n[t].p,o=o.replace(n[t].reg,i);return o}function s(e,t){var a,i,l,r,u,c,p,S,h,g,b="",m=e.nodeType;e.nodeName;if(1===m){if(h=e.attributes,i=e.tagName.toUpperCase(),i.match(/h\d/i)&&d.push([e,"","header"]),h["ssml:ph"])return b=h["ssml:ph"].value,b=b.split("/").join(" "),void d.push([e,b,"ssml"]);if("SCRIPT"===i||"RP"===i)return;if("RT"===i&&"TEXT"===X.TTS.Type)return;if("IMG"===i)return b=e.alt,void(b.length>0&&d.push([e,b,"alt"]))}if(3!==m){if("undefined"!=typeof e.childNodes){a=e.childNodes;for(n in a)s(a[n],t)}}else if(b=e.nodeValue,g="text",t&&(S=o(b,t),S!==b&&(b=S,g="text+PLS")),b.trim().length>0)if(b.length<T)d.push([e,b,g]);else{for(r=0,u=b.length,p="",l=[],r=0;r<u;r++)c=b.charAt(r),"ja-JP"===f.lang&&c.match(/[\s,。、(「（]/)?(l.push(p+c),p=""):c.match(/[“".,(]/)?(l.push(p+c),p=""):p+=c;for(l.push(p),u=l.length,p=S="",r=0;r<u;r++)""!==l[r].trim()&&(S=p+l[r].trim(),S.length>T?(p.length>0&&d.push([e,p.trim(),g]),p=l[r]):p=S);p.length>0&&d.push([e,p.trim(),g])}}function l(e){var n=[];return sML.each(e.querySelectorAll("lexeme"),function(){var e,t,a=this,i=a.getElementsByTagName("grapheme"),o=a.getElementsByTagName("phoneme");i&&o&&(t=new RegExp(i[0].textContent,"ig"),e=o[0].textContent,n.push({g:i[0].textContent,p:e.split("/").join(" "),reg:t}))}),n}function r(e,n){var t=[],a=new DOMParser;O.download(e).then(function(e){var i=a.parseFromString(e.responseText,"application/xml");return console.log(i),i.getElementsByTagName("parsererror").length?void n(!1):(t=l(i),void n(t))})}function u(){var e,n,t,a,o,l="start TTS",u=R.getCurrent(),c=R.getCurrentPages();u.Pages;t=c.StartPage.Item.ItemIndex+1,console.log("--start TTS--"),d=[],d.length=0,p=!1,e=u.Page.Item,n=u.Page.Item.Body,l=e.contentDocument,console.log(e.src),sML.each(l.querySelectorAll("link"),function(){var n=this.attributes;console.log(n.rel.nodeValue),n&&"pronunciation"===n.rel.nodeValue&&(o=n.hreflang.nodeValue,a=new URL(n.href.nodeValue,e.src),p=!0,console.log("this is PLS ",a,o))}),p?r(a.href,function(e){s(n,e),console.log(e),console.table(d),i(0,u)}):(s(n,!1),console.table(d),i(0,u))}var c,p,T=40,d=[],h=0,g="#FFD700",f=new SpeechSynthesisUtterance;if(X.TTS={},X.TTS.isSpeeking=!1,X.TTS.Type="TEXT",X.TTS.Rate=1.5,f.volume=1,f.rate=1.5,f.pitch=1,f.lang="ja-JP",O.appendStyleSheetLink({className:"bibi-extension-stylesheet",id:"bibi-extension-stylesheet_TTS",href:O.RootPath+"extensions/tts/tts.css"}),!1 in window)return void O.log(2,"plugin Error - TTS Plugin:Web Speech API is disabled");if(S["use-cookie"]){var b=O.Cookie.remember(O.RootPath);b&&b.TTS&&void 0!=b.TTS.Rate&&(f.rate=X.TTS.Rate=1*b.TTS.Rate)}("number"!=typeof X.TTS.Rate||X.TTS.Rate<.5||X.TTS.Rate>10)&&(f.rate=X.TTS.Rate=1.5),I.Menu.TTS={};var m=I.createButtonGroup({Area:I.Menu.R,Sticky:!0}),y=m.addButton({Type:"toggle",Labels:{"default":{"default":"TTS",ja:"読み上げ"},active:{"default":"Close Share-Menu",ja:"読み上げメニューを閉じる"}},Help:!0,Icon:'<span class="bibi-icon bibi-icon-speech"></span>'}),v=I.createSubPanel({Opener:y,id:"bibi-subpanel_tts",open:function(){console.log("open tts sub panel")}});I.Menu.TTS.Speech=v.addSection({Labels:{"default":{"default":"Text To Speech",ja:"読み上げ"}},ButtonGroup:{Tiled:!1,Buttons:[{Type:"toggle",Labels:{"default":{"default":"Start Speech",ja:"読み上げを開始"},active:{"default":"Stop Speech",ja:"読み上げを停止"}},Icon:'<span class="bibi-icon bibi-icon-speech-on"></span>',action:function(){X.TTS.isSpeeking=!X.TTS.isSpeeking,v.close(),X.TTS.isSpeeking?u():speechSynthesis.cancel(f)},on:{click:function(){return!1}}},{Type:"toggle",Labels:{"default":{"default":"Speech Ruby text",ja:"ルビも読み上げする"},active:{"default":"Speech non-ruby text only",ja:"ルビは読み上げない"}},Icon:'<span class="bibi-icon bibi-icon-speech-on"></span>',action:function(){speechSynthesis.cancel(f),"TEXT"===X.TTS.Type?X.TTS.Type="RUBY":X.TTS.Type="TEXT",X.TTS.isSpeeking&&(X.TTS.isSpeeking=!1,setTimeout(function(){X.TTS.isSpeeking=!0,u()},1e3))},on:{click:function(){return!1}}}]}}),I.Menu.TTS.Rate=v.addSection({Labels:{"default":{"default":"Speech Rate",ja:"読み上げ速度"}},ButtonGroup:{Tiled:!0,Buttons:[{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> Normal',ja:'<span class="non-visual-in-label">読み上げ速度：</span>標準'}},Icon:"",Rate:1,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 1.5 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>1.5倍速'}},Icon:"",Rate:1.5,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 2 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>2倍速'}},Icon:"",Rate:2,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 3 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>3倍速'}},Icon:"",Rate:3,action:e}]}}),I.Menu.TTS.Rate.ButtonGroup.Buttons.forEach(function(e){e.Rate==X.TTS.Rate&&I.setUIState(e,"active")}),E.bind("bibi:commands:move-by",function(){console.log("moved"),t()}),E.bind("bibi:downs-key",function(e){function n(){speechSynthesis.cancel(f),X.TTS.isSpeeking=!1;var e=d[h][0],n=(d[h][1],e.parentElement),t=n.style;1===n.nodeType&&t&&(t.backgroundColor="")}var t,a=0;if("Up Arrow"===e.BibiKeyName&&e.shiftKey){for(n(),a=h,a>0&&"header"===d[a-1][2]&&(a-=2);a>0&&(t=d[a],"header"!==t[2]);)a--;a<0&&(a=0),setTimeout(function(){X.TTS.isSpeeking=!0,i(a,c)},1e3)}else if("Down Arrow"===e.BibiKeyName&&e.shiftKey){for(n(),a=h;a<d.length&&(t=d[a],"header"!==t[2]);)a++;setTimeout(function(){X.TTS.isSpeeking=!0,i(a,c)},1e3)}else"Up Arrow"===e.BibiKeyName?(n(),a=h-2,a<0&&(a=0),setTimeout(function(){X.TTS.isSpeeking=!0,i(a,c)},1e3)):"Down Arrow"===e.BibiKeyName&&(n(),a=h+1,setTimeout(function(){X.TTS.isSpeeking=!0,i(a,c)},100))}),E.bind("bibi:loaded-items",function(e){console.log("bibi:loaded-items")})});