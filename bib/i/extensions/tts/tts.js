/*!
 *
 * # BiB/i Extension: OverReflow
 *
 * - "Overlays Reflowable Content Layers on Pre-Paginated Book"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
Bibi.x({name:"Text To Speech",description:"text to speech for BiB/i",version:"0.1.0",build:20170611.0001})(function(){function e(){var e=this,n=e.Rate;r.rate=X.TTS.Rate=n,S["use-cookie"]&&O.Cookie.eat(O.RootPath,{TTS:{Rate:n}})}function t(){var e=I.Menu.TTS.Speech.ButtonGroup.Buttons;speechSynthesis.cancel(r),X.TTS.isSpeeking=!1,I.setUIState(e[0],"default")}function a(){var e,n=R.Current.Pages.EndPage!=R.Pages[R.Pages.length-1]||100!=R.Current.Pages.EndPageRatio,a=(R.Current.Pages.EndPage,R.Current.Pages.StartPage),i=R.getCurrent(),s=i.Page.PageIndex;c=[],c.length=0,e=a.Item.ItemIndex+1,s=e+1,n?(R.focusOn(s),setTimeout(o,1e3)):t()}function i(e,n){var t,s,o,u,S=c.length;if(e>=S)return a(),!0;if(e<0&&(e=0),T=e,l=n,X.TTS.isSpeeking){if(s=c[e][0],t=c[e][1],0===t.length)return void i(e+1,n);o=s.parentElement,u=o.style,1===o.nodeType&&u&&(u.backgroundColor=p),R.focusOn({Destination:{Element:o,Page:n.Page}}),r.text=t,r.onerror=function(e){return!1},r.onstart=function(e){speaking=!0},r.onend=function(t){speaking=!1,u&&(u.backgroundColor=""),setTimeout(function(){i(e+1,n)},10)},speechSynthesis.speak(r)}}function s(e){var t,a,i,o,l,T,p,S,d,h="",f=e.nodeType;e.nodeName;if(1===f){if(d=e.attributes,a=e.tagName.toUpperCase(),a.match(/h\d/i)&&c.push([e,"","header"]),d["ssml:ph"])return h=d["ssml:ph"].value,h=h.split("/").join(" "),void c.push([e,h,"ssml"]);if("SCRIPT"===a||"RP"===a)return;if("RT"===a&&"TEXT"===X.TTS.Type)return;if("IMG"===a)return h=e.alt,void(h.length>0&&c.push([e,h,"alt"]))}if(3!==f){if("undefined"!=typeof e.childNodes){t=e.childNodes;for(n in t)s(t[n])}}else if(h=e.nodeValue,h.trim().length>0)if(h.length<u)c.push([e,h,"text"]);else{for(o=0,l=h.length,p="",i=[],o=0;o<l;o++)T=h.charAt(o),"ja-JP"===r.lang&&T.match(/[\s,。、(「（]/)?(i.push(p+T),p=""):T.match(/[“".,(]/)?(i.push(p+T),p=""):p+=T;for(i.push(p),l=i.length,p=S="",o=0;o<l;o++)""!==i[o].trim()&&(S=p+i[o].trim(),S.length>u?(p.length>0&&c.push([e,p.trim(),"text"]),p=i[o]):p=S);p.length>0&&c.push([e,p.trim(),"text"])}}function o(){var e,n=R.getCurrent(),t=R.getCurrentPages();n.Pages;e=t.StartPage.Item.ItemIndex+1,console.log("--start TTS--"),c=[],c.length=0,s(n.Page.Item.Body),i(0,n)}var l,u=40,c=[],T=0,p="#FFD700",r=new SpeechSynthesisUtterance;if(X.TTS={},X.TTS.isSpeeking=!1,X.TTS.Type="TEXT",X.TTS.Rate=1.5,r.volume=1,r.rate=1.5,r.pitch=1,r.lang="ja-JP",O.appendStyleSheetLink({className:"bibi-extension-stylesheet",id:"bibi-extension-stylesheet_TTS",href:O.RootPath+"extensions/tts/tts.css"}),!1 in window)return void O.log(2,"plugin Error - TTS Plugin:Web Speech API is disabled");if(S["use-cookie"]){var d=O.Cookie.remember(O.RootPath);d&&d.TTS&&void 0!=d.TTS.Rate&&(r.rate=X.TTS.Rate=1*d.TTS.Rate)}("number"!=typeof X.TTS.Rate||X.TTS.Rate<.5||X.TTS.Rate>10)&&(r.rate=X.TTS.Rate=1.5),I.Menu.TTS={};var h=I.createButtonGroup({Area:I.Menu.R,Sticky:!0}),f=h.addButton({Type:"toggle",Labels:{"default":{"default":"TTS",ja:"読み上げ"},active:{"default":"Close Share-Menu",ja:"読み上げメニューを閉じる"}},Help:!0,Icon:'<span class="bibi-icon bibi-icon-speech"></span>'}),g=I.createSubPanel({Opener:f,id:"bibi-subpanel_tts",open:function(){console.log("open tts sub panel")}});I.Menu.TTS.Speech=g.addSection({Labels:{"default":{"default":"Text To Speech",ja:"読み上げ"}},ButtonGroup:{Tiled:!1,Buttons:[{Type:"toggle",Labels:{"default":{"default":"Start Speech",ja:"読み上げを開始"},active:{"default":"Stop Speech",ja:"読み上げを停止"}},Icon:'<span class="bibi-icon bibi-icon-speech-on"></span>',action:function(){X.TTS.isSpeeking=!X.TTS.isSpeeking,g.close(),X.TTS.isSpeeking?o():speechSynthesis.cancel(r)},on:{click:function(){return!1}}},{Type:"toggle",Labels:{"default":{"default":"Speech Ruby text",ja:"ルビも読み上げする"},active:{"default":"Speech non-ruby text only",ja:"ルビは読み上げない"}},Icon:'<span class="bibi-icon bibi-icon-speech-on"></span>',action:function(){speechSynthesis.cancel(r),"TEXT"===X.TTS.Type?X.TTS.Type="RUBY":X.TTS.Type="TEXT",X.TTS.isSpeeking&&(X.TTS.isSpeeking=!1,setTimeout(function(){X.TTS.isSpeeking=!0,o()},1e3))},on:{click:function(){return!1}}}]}}),I.Menu.TTS.Rate=g.addSection({Labels:{"default":{"default":"Speech Rate",ja:"読み上げ速度"}},ButtonGroup:{Tiled:!0,Buttons:[{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> Normal',ja:'<span class="non-visual-in-label">読み上げ速度：</span>標準'}},Icon:"",Rate:1,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 1.5 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>1.5倍速'}},Icon:"",Rate:1.5,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 2 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>2倍速'}},Icon:"",Rate:2,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 3 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>3倍速'}},Icon:"",Rate:3,action:e}]}}),I.Menu.TTS.Rate.ButtonGroup.Buttons.forEach(function(e){e.Rate==X.TTS.Rate&&I.setUIState(e,"active")}),E.bind("bibi:commands:move-by",function(){console.log("moved"),t()}),E.bind("bibi:downs-key",function(e){function n(){speechSynthesis.cancel(r),X.TTS.isSpeeking=!1;var e=c[T][0],n=(c[T][1],e.parentElement),t=n.style;1===n.nodeType&&t&&(t.backgroundColor="")}var t,a=0;if("Up Arrow"===e.BibiKeyName&&e.shiftKey){for(n(),a=T,a>0&&"header"===c[a-1][2]&&(a-=2);a>0&&(t=c[a],"header"!==t[2]);)a--;a<0&&(a=0),setTimeout(function(){X.TTS.isSpeeking=!0,i(a,l)},1e3)}else if("Down Arrow"===e.BibiKeyName&&e.shiftKey){for(n(),a=T;a<c.length&&(t=c[a],"header"!==t[2]);)a++;setTimeout(function(){X.TTS.isSpeeking=!0,i(a,l)},1e3)}else"Up Arrow"===e.BibiKeyName?(n(),a=T-2,a<0&&(a=0),setTimeout(function(){X.TTS.isSpeeking=!0,i(a,l)},1e3)):"Down Arrow"===e.BibiKeyName&&(n(),a=T+1,setTimeout(function(){X.TTS.isSpeeking=!0,i(a,l)},100))})});