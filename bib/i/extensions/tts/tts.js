/*!
 *
 * # BiB/i Extension: OverReflow
 *
 * - "Overlays Reflowable Content Layers on Pre-Paginated Book"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
Bibi.x({name:"Text To Speech",description:"text to speech for BiB/i",version:"0.1.0",build:20170611.0001})(function(){function e(n,t){var i,o,r,u,p=s.length;return n>=p?(X.TTS.isSpeeking=!1,!0):void(X.TTS.isSpeeking&&(o=s[n][0],i=s[n][1],r=o.parentElement,u=r.style,u.backgroundColor=a,R.focusOn({Destination:{Element:r,Page:t.Page}}),l.text=i,l.onerror=function(e){return O.log(2,"plugin Error - TTS Plugin:"+e),!1},l.onstart=function(e){speaking=!0,O.log(2,"plugin TTS speak: "+i)},l.onend=function(i){speaking=!1,u.backgroundColor="",setTimeout(function(){e(n+1,t)},500)},speechSynthesis.speak(l)))}function t(e){var i,a,r,u,p,c,g,h,d,S="",T=e.nodeType;e.nodeName;if(1===T){if(d=e.attributes,d["ssml:ph"])return S=d["ssml:ph"].value,void s.push([e,S]);if(a=e.tagName.toUpperCase(),"RT"===a||"RP"===a||"SCRIPT"===a)return void console.log("skip tag ->",a);if("IMG"===a)return S=e.alt,void(S.length>0&&s.push([e,S]))}if(3!==T){if("undefined"!=typeof e.childNodes){i=e.childNodes;for(n in i)t(i[n])}}else if(S=e.nodeValue,S.trim().length>0)if(S.length<o)s.push([e,S]);else{for(u=0,p=S.length,g="",r=[],u=0;u<p;u++)c=S.charAt(u),"ja-JP"===l.lang&&c.match(/[\s,。、(「（]/)?(r.push(g+c),g=""):c.match(/[“".,(]/)?(r.push(g+c),g=""):g+=c;for(r.push(g),p=r.length,g=h="",u=0;u<p;u++)""!==r[u].trim()&&(h=g+r[u].trim(),h.length>o?(g.length>0&&s.push([e,g.trim()]),g=r[u]):g=h);g.length>0&&s.push([e,g.trim()])}}function i(){var n,i,o,a,l=R.getCurrent(),r=(R.getCurrentPages(),l.Pages);for(s=[],i=r.length,n=0;n<i;n++)o=r[n].Item,a=o.Body,t(a);e(0,l)}var o=40,s=[],a="#FFD700",l=new SpeechSynthesisUtterance;if(X.TTS={},X.TTS.isSpeeking=!1,l.volume=1,l.rate=1,l.pitch=1,l.lang="ja-JP",O.appendStyleSheetLink({className:"bibi-extension-stylesheet",id:"bibi-extension-stylesheet_TTS",href:O.RootPath+"extensions/tts/tts.css"}),!1 in window)return void O.log(2,"plugin Error - TTS Plugin:Web Speech API is disabled");var r=I.createButtonGroup({Area:I.Menu.R,Sticky:!0}),u=r.addButton({Type:"toggle",Labels:{"default":{"default":"TTS",ja:"読み上げ"},active:{"default":"Close Share-Menu",ja:"読み上げメニューを閉じる"}},Help:!0,Icon:'<span class="bibi-icon bibi-icon-speech"></span>'}),p=I.createSubPanel({Opener:u,id:"bibi-subpanel_tts",open:function(){console.log("open tts sub panel")}});p.addSection({Labels:{"default":{"default":"Text To Speech",ja:"読み上げ"}},ButtonGroup:{Tiled:!0,Buttons:[{Type:"toggle",Labels:{"default":{"default":"Start Speech",ja:"読み上げを開始"},active:{"default":"Stop Speech",ja:"読み上げを停止"}},Icon:'<span class="bibi-icon bibi-icon-speech-on"></span>',action:function(){X.TTS.isSpeeking=!X.TTS.isSpeeking,console.log("SP -- ",X.TTS.isSpeeking),p.close(),X.TTS.isSpeeking&&i()},on:{click:function(){return!1}}}]}}),E.bind("bibi:commands:move-by",function(){console.log("moved"),X.TTS.isSpeeking})});