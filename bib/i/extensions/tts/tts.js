/*!
 *
 * # BiB/i Extension: OverReflow
 *
 * - "Overlays Reflowable Content Layers on Pre-Paginated Book"
 * - Copyright (c) Satoru MATSUSHIMA - http://bibi.epub.link/ or https://github.com/satorumurmur/bibi
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
Bibi.x({name:"Text To Speech",description:"text to speech for BiB/i",version:"0.1.0",build:20170611.0001})(function(){function e(){var e=this,t=e.Rate;p.rate=X.TTS.Rate=t,S["use-cookie"]&&O.Cookie.eat(O.RootPath,{TTS:{Rate:t}})}function t(){var e=I.Menu.TTS.Speech.ButtonGroup.Buttons;speechSynthesis.cancel(p),X.TTS.isSpeeking=!1,I.setUIState(e[0],"default")}function a(){var e,n=R.Current.Pages.EndPage!=R.Pages[R.Pages.length-1]||100!=R.Current.Pages.EndPageRatio,a=(R.Current.Pages.EndPage,R.Current.Pages.StartPage),i=R.getCurrent(),s=i.Page.PageIndex;u=[],u.length=0,e=a.Item.ItemIndex+1,s=e+1,n?(R.focusOn(s),setTimeout(o,1e3)):t()}function i(e,t){var n,s,o,l,T=u.length;return e>=T?(a(),!0):void(X.TTS.isSpeeking&&(s=u[e][0],n=u[e][1],o=s.parentElement,l=o.style,l.backgroundColor=c,R.focusOn({Destination:{Element:o,Page:t.Page}}),p.text=n,p.onerror=function(e){return!1},p.onstart=function(e){speaking=!0},p.onend=function(n){speaking=!1,l.backgroundColor="",setTimeout(function(){i(e+1,t)},10)},speechSynthesis.speak(p)))}function s(e){var t,a,i,o,c,T,r,S,d,h="",f=e.nodeType;e.nodeName;if(1===f){if(d=e.attributes,d["ssml:ph"])return h=d["ssml:ph"].value,void u.push([e,h]);if(a=e.tagName.toUpperCase(),"SCRIPT"===a||"RP"===a)return;if("RT"===a&&"TEXT"===X.TTS.Type)return;if("IMG"===a)return h=e.alt,void(h.length>0&&u.push([e,h]))}if(3!==f){if("undefined"!=typeof e.childNodes){t=e.childNodes;for(n in t)s(t[n])}}else if(h=e.nodeValue,h.trim().length>0)if(h.length<l)u.push([e,h]);else{for(o=0,c=h.length,r="",i=[],o=0;o<c;o++)T=h.charAt(o),"ja-JP"===p.lang&&T.match(/[\s,。、(「（]/)?(i.push(r+T),r=""):T.match(/[“".,(]/)?(i.push(r+T),r=""):r+=T;for(i.push(r),c=i.length,r=S="",o=0;o<c;o++)""!==i[o].trim()&&(S=r+i[o].trim(),S.length>l?(r.length>0&&u.push([e,r.trim()]),r=i[o]):r=S);r.length>0&&u.push([e,r.trim()])}}function o(){var e,t=R.getCurrent(),n=R.getCurrentPages();t.Pages;e=n.StartPage.Item.ItemIndex+1,u=[],u.length=0,s(n.StartPage.Item.Body),i(0,t)}var l=40,u=[],c="#FFD700",p=new SpeechSynthesisUtterance;if(X.TTS={},X.TTS.isSpeeking=!1,X.TTS.Type="TEXT",X.TTS.Rate=1.5,p.volume=1,p.rate=1.5,p.pitch=1,p.lang="ja-JP",O.appendStyleSheetLink({className:"bibi-extension-stylesheet",id:"bibi-extension-stylesheet_TTS",href:O.RootPath+"extensions/tts/tts.css"}),!1 in window)return void O.log(2,"plugin Error - TTS Plugin:Web Speech API is disabled");if(S["use-cookie"]){var T=O.Cookie.remember(O.RootPath);T&&T.TTS&&void 0!=T.TTS.Rate&&(p.rate=X.TTS.Rate=1*T.TTS.Rate)}("number"!=typeof X.TTS.Rate||X.TTS.Rate<.5||X.TTS.Rate>10)&&(p.rate=X.TTS.Rate=1.5),I.Menu.TTS={};var r=I.createButtonGroup({Area:I.Menu.R,Sticky:!0}),d=r.addButton({Type:"toggle",Labels:{"default":{"default":"TTS",ja:"読み上げ"},active:{"default":"Close Share-Menu",ja:"読み上げメニューを閉じる"}},Help:!0,Icon:'<span class="bibi-icon bibi-icon-speech"></span>'}),h=I.createSubPanel({Opener:d,id:"bibi-subpanel_tts",open:function(){console.log("open tts sub panel")}});I.Menu.TTS.Speech=h.addSection({Labels:{"default":{"default":"Text To Speech",ja:"読み上げ"}},ButtonGroup:{Tiled:!1,Buttons:[{Type:"toggle",Labels:{"default":{"default":"Start Speech",ja:"読み上げを開始"},active:{"default":"Stop Speech",ja:"読み上げを停止"}},Icon:'<span class="bibi-icon bibi-icon-speech-on"></span>',action:function(){X.TTS.isSpeeking=!X.TTS.isSpeeking,h.close(),X.TTS.isSpeeking?o():speechSynthesis.cancel(p)},on:{click:function(){return!1}}},{Type:"toggle",Labels:{"default":{"default":"Onry text",ja:"ルビは読み上げない"},active:{"default":"Speech Ruby",ja:"ルビも読み上げる"}},Icon:'<span class="bibi-icon bibi-icon-speech-on"></span>',action:function(){speechSynthesis.cancel(p),"TEXT"===X.TTS.Type?X.TTS.Type="RUBY":X.TTS.Type="TEXT",X.TTS.isSpeeking&&(X.TTS.isSpeeking=!1,setTimeout(function(){X.TTS.isSpeeking=!0,o()},1e3))},on:{click:function(){return!1}}}]}}),I.Menu.TTS.Rate=h.addSection({Labels:{"default":{"default":"Speech Rate",ja:"読み上げ速度"}},ButtonGroup:{Tiled:!0,Buttons:[{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> Normal',ja:'<span class="non-visual-in-label">読み上げ速度：</span>標準'}},Icon:"",Rate:1,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 1.5 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>1.5倍速'}},Icon:"",Rate:1.5,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 2 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>2倍速'}},Icon:"",Rate:2,action:e},{Type:"radio",Labels:{"default":{"default":'<span class="non-visual-in-label">Speech Rate:</span> 3 speed',ja:'<span class="non-visual-in-label">読み上げ速度：</span>3倍速'}},Icon:"",Rate:3,action:e}]}}),I.Menu.TTS.Rate.ButtonGroup.Buttons.forEach(function(e){e.Rate==X.TTS.Rate&&I.setUIState(e,"active")}),E.bind("bibi:commands:move-by",function(){console.log("moved"),t()})});