/*!
 *
 * # BiB/i Extension: OpenBD
 *
 * - "openBD extension for Bib/i"
 * - Copyright (c) Shunsuke Ito - https://twitter.com/shunito
 * - Licensed under the MIT license. - http://www.opensource.org/licenses/mit-license.php
 */
Bibi.x({name:"openBD",description:"openBD extension for Bib/i",version:"0.1.0",build:20170128.0001})(function(){function e(e){var t=/urn:isbn:(\w+)/i,n=e.match(t);return!!n&&n[1]}function t(){for(var e=[],t=location.search.substring(1).split("&"),n=0;t[n];n++)if(e=t[n].split("="),"isbn"===e[0].toLowerCase())return e[1];return!1}function n(e){return"string"==typeof e?e.replace(/\n/g,"<br>"):e}function o(e){var t,o,i,r;for("undefined"!=typeof e.summary&&(t=e.summary),"undefined"!=typeof e.onix.CollateralDetail.TextContent&&(textContent=e.onix.CollateralDetail.TextContent),"undefined"!=typeof e.onix.DescriptiveDetail.Contributor&&(o=e.onix.DescriptiveDetail.Contributor),i=['<h2 style="font-size:1.4em; font-weight:bold; border-top:1px solid #CCC; padding-top:1em;">',t.title,"</h2>",'<p style="margin:0.5em;">',t.author,"  &nbsp;(",t.publisher,")</p>"].join(""),t.cover&&(i+=['<img src="',t.cover,'" alt="',t.title,'カバー" style="max-width:100%;margin-right:1em;float:left;">'].join("")),r=0;r<textContent.length;r++)i+=['<p style="margin-bottom:0.5em; line-height:1.4;">',n(textContent[r].Text),"</p>"].join("");for(r=0;r<o.length;r++)i+=['<p style="margin:1em 0.5em 0.5em 0.5em; line-height:1.4; font-weight:bold; clear:both;">',n(o[r].PersonName.content),"</p>",'<p style="margin-bottom:0.5em; margin-left:1em; line-height:1.4;">',n(o[r].BiographicalNote),"</p>"].join("");i+=['<p style="clear:both;margin-bottom:20px;">powerd by <a href="https://openbd.jp/">openBD</a></p>'].join(""),I.Panel.BookInfo.openBD=I.Panel.BookInfo.Box.appendChild(sML.create("div",{id:"bibi-panel-bookinfo-openbd",innerHTML:i}))}function i(e){var t=a+e;e&&O.download(t).then(function(e){var t=JSON.parse(e.responseText);o(t[0])})}var r=!0,a="https://api.openbd.jp/v1/get?isbn=";E.bind("bibi:loaded-package-document",function(){if(void 0!==typeof B.Package.Metadata.identifier){O.log("openBD extension Loading","*:");var n=B.Package.Metadata.identifier,o=e(n);O.log("EPUB identifier: "+n,"-*"),o&&O.log("EPUB ISBN: "+o,"-*"),r&&(o=t(),o&&O.log("EPUB ISBN overwrite: "+o,"-*")),i(o),O.log("openBD extension Loaded.","/*")}})});